# SCD Schema Definition
# Version: 0.1.0 (Draft)
#
# This schema defines the structure for Structured Context Documents (SCDs)
# used by scs-vibe to generate AI coding assistant context.

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://structuredcontext.io/schemas/scd/0.1.0"
title: Structured Context Document (SCD)
description: |
  A structured document that captures context for AI coding assistants.
  SCDs are the source of truth, compiled to native formats (CLAUDE.md, AGENTS.md, etc.)

type: object
required:
  - id
  - tier
  - title
  - content

properties:
  # ============================================================================
  # IDENTIFICATION
  # ============================================================================

  id:
    type: string
    pattern: "^scd:(meta|standards|project):[a-z0-9-]+$"
    description: |
      Unique identifier for this SCD.
      Format: scd:<tier>:<name>
      Examples: scd:project:tech-stack, scd:standards:hipaa-rules
    examples:
      - "scd:project:system-overview"
      - "scd:project:tech-stack"
      - "scd:standards:hipaa-phi-rules"

  tier:
    type: string
    enum: [meta, standards, project]
    description: |
      The tier determines scope and ownership:
      - meta: SCS specification itself (owned by SCS)
      - standards: External compliance requirements (owned by standards bodies)
      - project: Project-specific context (owned by project team)

  title:
    type: string
    maxLength: 100
    description: Human-readable title for this SCD
    examples:
      - "Technology Stack"
      - "PHI Handling Rules"
      - "Domain Terminology"

  version:
    type: string
    pattern: "^(DRAFT|[0-9]+\\.[0-9]+\\.[0-9]+)$"
    default: "DRAFT"
    description: |
      Semantic version or DRAFT.
      DRAFT indicates work-in-progress, not yet validated/locked.
    examples:
      - "DRAFT"
      - "1.0.0"
      - "2.1.3"

  # ============================================================================
  # METADATA
  # ============================================================================

  metadata:
    type: object
    description: Optional metadata about this SCD
    properties:
      owner:
        type: string
        description: Person or team responsible for this SCD
        examples:
          - "Engineering Team"
          - "Dr. Sarah Chen (Compliance)"

      created_at:
        type: string
        format: date-time
        description: When this SCD was created

      updated_at:
        type: string
        format: date-time
        description: When this SCD was last updated

      tags:
        type: array
        items:
          type: string
        description: Searchable tags for categorization
        examples:
          - ["healthcare", "phi", "compliance"]
          - ["python", "cli", "architecture"]

      priority:
        type: string
        enum: [critical, high, normal, low]
        default: normal
        description: |
          How important this context is:
          - critical: Must always be loaded (compliance, safety)
          - high: Load early in context window
          - normal: Standard loading
          - low: Can be compressed/summarized if context is tight

  # ============================================================================
  # APPLICABILITY
  # ============================================================================

  applies_to:
    type: object
    description: When this SCD should be loaded
    properties:
      paths:
        type: array
        items:
          type: string
        description: |
          Glob patterns for files where this SCD applies.
          If empty or omitted, applies globally.
        examples:
          - ["**/*"]  # Global
          - ["src/api/**/*.py", "src/services/**/*.py"]  # API files only
          - ["careplan/service.py", "careplan/storage.py"]  # Specific files

      conditions:
        type: array
        items:
          type: string
        description: |
          Named conditions when this SCD applies.
          Future: could be tied to project config.
        examples:
          - ["healthcare-mode"]
          - ["production-deployment"]

    default:
      paths: ["**/*"]  # Global by default

  # ============================================================================
  # CONTENT
  # ============================================================================

  content:
    type: object
    description: |
      The actual context content. Structure varies by SCD type.
      Common patterns are defined below, but content is flexible.

    properties:
      summary:
        type: string
        description: One-line summary (used in compiled headers)

      # Free-form sections - any key is allowed
      # Common patterns:

      sections:
        type: array
        description: Ordered sections of content
        items:
          type: object
          required: [heading, body]
          properties:
            heading:
              type: string
            body:
              type: string
            format:
              type: string
              enum: [prose, list, table, code]
              default: prose

      layers:
        type: array
        description: For tech stack - layer/technology pairs
        items:
          type: object
          required: [layer, technology]
          properties:
            layer:
              type: string
            technology:
              type: string
            notes:
              type: string

      patterns:
        type: object
        description: For patterns SCD - what we use/avoid
        properties:
          use:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                where:
                  type: string
                why:
                  type: string
                example:
                  type: string
          avoid:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                why:
                  type: string
                instead:
                  type: string

      rules:
        type: array
        description: For compliance/constraint SCDs - explicit rules
        items:
          type: string

      terms:
        type: array
        description: For domain context - terminology definitions
        items:
          type: object
          required: [term, definition]
          properties:
            term:
              type: string
            definition:
              type: string

      checklist:
        type: array
        description: For development guidelines - before/after checklists
        items:
          type: string

    additionalProperties: true  # Allow custom content structures

  # ============================================================================
  # OUTPUT CONFIGURATION
  # ============================================================================

  output:
    type: object
    description: How to compile this SCD for different targets
    properties:

      claude_code:
        type: object
        description: Claude Code output configuration
        properties:
          file:
            type: string
            description: Output file path (relative to project root)
            examples:
              - "CLAUDE.md"
              - ".claude/rules/tech-stack.md"

          section:
            type: string
            description: If merging into another file, the section heading

          include_paths_frontmatter:
            type: boolean
            default: false
            description: Add paths YAML frontmatter for conditional loading

          format:
            type: string
            enum: [prose, table, list, mixed]
            default: mixed
            description: Preferred rendering format

      codex:
        type: object
        description: OpenAI Codex output configuration
        properties:
          file:
            type: string
            description: Output file path
            examples:
              - "AGENTS.md"
              - "backend/AGENTS.md"

          section:
            type: string
            description: Section heading within file

      cursor:
        type: object
        description: Cursor output configuration
        properties:
          file:
            type: string
            default: ".cursorrules"

          section:
            type: string

      generic:
        type: object
        description: Generic markdown output
        properties:
          file:
            type: string
            default: "CONTEXT.md"

  # ============================================================================
  # RELATIONSHIPS
  # ============================================================================

  depends_on:
    type: array
    items:
      type: string
      pattern: "^scd:(meta|standards|project):[a-z0-9-]+$"
    description: |
      Other SCDs this one depends on.
      Compiler ensures dependencies are included.
    examples:
      - ["scd:standards:hipaa-rules"]
      - ["scd:project:system-overview"]

  supersedes:
    type: string
    pattern: "^scd:(meta|standards|project):[a-z0-9-]+$"
    description: |
      If this SCD replaces another, reference it here.
      Useful for deprecation/migration.

# ============================================================================
# SCHEMA METADATA
# ============================================================================

$defs:
  # Reusable definitions can go here

  glob_pattern:
    type: string
    description: A glob pattern for file matching
    examples:
      - "**/*.py"
      - "src/api/**/*"
      - "careplan/service.py"
